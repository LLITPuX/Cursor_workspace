# Gemini Observer: –ü–ª–∞–Ω —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó Stream Architecture V2

> [!IMPORTANT]
> –¶–µ–π –ø–ª–∞–Ω —Ä–µ–∞–ª—ñ–∑—É—î 5-–ø–æ—Ç–æ–∫–æ–≤—É –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É, –≤–∏–∑–Ω–∞—á–µ–Ω—É –≤ `.agent/rules/gemini-stream-architecture-v2.md`.
> –í—ñ–Ω –ø–µ—Ä–µ–¥–±–∞—á–∞—î –ø–µ—Ä–µ—Ö—ñ–¥ —Å–∏—Å—Ç–µ–º–∏ –≤—ñ–¥ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ü–∏–∫–ª—É –∑–∞–ø–∏—Ç-–≤—ñ–¥–ø–æ–≤—ñ–¥—å –¥–æ —Å–∫–ª–∞–¥–Ω–æ–≥–æ –∫–æ–≥–Ω—ñ—Ç–∏–≤–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∑ –ø–∞–º'—è—Ç—Ç—é, —ñ–Ω—Ç—É—ó—Ü—ñ—î—é —Ç–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—é –¥–æ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è.

## üìÖ –û–≥–ª—è–¥ –µ—Ç–∞–ø—ñ–≤

| –ï—Ç–∞–ø | –ù–∞–∑–≤–∞ | –§–æ–∫—É—Å | –ö–ª—é—á–æ–≤—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ |
| :--- | :--- | :--- | :--- |
| **0** | **–ê–Ω–∞–ª—ñ–∑ —Ç–∞ –î–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è** | `core/loop.py`, `transport/telegram_bot.py` | –ê—É–¥–∏—Ç –∫–æ–¥—É, –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —á–∞—Å—Ç–∏–Ω –¥–ª—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—è, –æ—á–∏—â–µ–Ω–Ω—è legacy. |
| **1** | **–§—É–Ω–¥–∞–º–µ–Ω—Ç** | Stream 1 (Scribe) & –°—Ö–µ–º–∞ –ì—Ä–∞—Ñ–∞ | –ú—ñ–≥—Ä–∞—Ü—ñ—è –ª–æ–≥—ñ–∫–∏ –∑–∞–ø–∏—Å—É –∑ `TelegramBot`, –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –≥—Ä–∞—Ñ—ñ. |
| **2** | **–ö–æ–≥–Ω—ñ—Ç–∏–≤–Ω—ñ—Å—Ç—å** | Stream 2 (Thinker) & Stream 3 (Analyst) | –î–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è `RalphLoop`, –≤–∏–Ω–µ—Å–µ–Ω–Ω—è Gatekeeper —Ç–∞ ContextBuilder. |
| **3** | **–î—ñ—è** | Stream 4 (Coordinator) & Stream 5 (Responder) | –ú—ñ–≥—Ä–∞—Ü—ñ—è `Researcher`, —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ Executor. |
| **4** | **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è** | –ü–æ–≤–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è `RalphLoop` | –ü–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ —á–∏—Å—Ç—É –ø–æ–¥—ñ–π–Ω–æ-–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω—É –º–æ–¥–µ–ª—å. |

---

## üõë –ï—Ç–∞–ø 0: –ê–Ω–∞–ª—ñ–∑ —Ç–∞ –î–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è (Migration Prep)

**–ú–µ—Ç–∞:** –ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –ø–ª–∞—Ü–¥–∞—Ä–º –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É, –Ω–µ –ª–∞–º–∞—é—á–∏ –ø–æ—Ç–æ—á–Ω—É —Ä–æ–±–æ—Ç—É "Ignition Phase".

### 0.1. –ê—É–¥–∏—Ç —ñ—Å–Ω—É—é—á–æ–≥–æ –∫–æ–¥—É
- [x] **Transport:** `transport/telegram_bot.py` –∑–∞—Ä–∞–∑ –∑–º—ñ—à—É—î –ª–æ–≥—ñ–∫—É —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É —Ç–∞ –∑–∞–ø–∏—Å—É –≤ –ë–î.
- [x] **Core:** `core/loop.py` (RalphLoop) —î –º–æ–Ω–æ–ª—ñ—Ç–æ–º, —â–æ –º—ñ—Å—Ç–∏—Ç—å Gatekeeper, RAG —Ç–∞ Generation.
- [x] **Memory:** `memory/falkordb.py` –º–∞—î –≥–∞—Ä–Ω—É –±–∞–∑—É –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, –∞–ª–µ –ø–æ—Ç—Ä–µ–±—É—î —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –¥–ª—è `Snapshots` —Ç–∞ `Tasks`. –ó–Ω–∞–π–¥–µ–Ω–æ legacy-–º–µ—Ç–æ–¥ `add_message` (Session/Event).

---

## üõ†Ô∏è –ï—Ç–∞–ø 1: –§—É–Ω–¥–∞–º–µ–Ω—Ç (The Scribe)

**–ú–µ—Ç–∞:** –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ "–î–∂–µ—Ä–µ–ª–æ –ü—Ä–∞–≤–¥–∏" —É FalkorDB. –ó–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –¥–µ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π –∑–∞–ø–∏—Å –∫–æ–∂–Ω–æ—ó –ø–æ–¥—ñ—ó.

### 1.1. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –°—Ö–µ–º–∏ –ì—Ä–∞—Ñ–∞
- [ ] –í–∏–∑–Ω–∞—á–∏—Ç–∏ —Ç–æ—á–Ω—ñ Cypher-–∑–∞–ø–∏—Ç–∏ –¥–ª—è –æ–±–º–µ–∂–µ–Ω—å (Unique IDs for Messages, Users, Chats).
- [ ] –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–ª–∞—Å `GraphSchema` –≤ `core/memory/schema.py`.
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–∫—Ä–∏–ø—Ç –º—ñ–≥—Ä–∞—Ü—ñ—ó –¥–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Å—Ö–µ–º–∏ –¥–æ FalkorDB.

### 1.2. Stream 1: –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è Scribe
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `streams/scribe.py`.
- [ ] **Refactor:** –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ª–æ–≥—ñ–∫—É `save_user_message` –∑ `telegram_bot.py` –≤ `Scribe`.
- [ ] **Cleanup:** –í–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä—è–º—ñ –≤–∏–∫–ª–∏–∫–∏ –ë–î –∑ `telegram_bot.py`. –ó—Ä–æ–±–∏—Ç–∏ –π–æ–≥–æ —á–∏—Å—Ç–∏–º "Producer" –¥–ª—è Redis.
- [ ] –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–ª–∞—Å `Scribe`, —â–æ —á–∏—Ç–∞—î –∑ `redis:ingestion_queue`.
- [ ] –õ–æ–≥—ñ–∫–∞ –¥–ª—è `MERGE User`, `MERGE Chat`, `MERGE Day`.
- [ ] –õ–æ–≥—ñ–∫–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è `(:Message)` —Ç–∞ –∑–≤'—è–∑–∫—ñ–≤ `[:NEXT]` (–•—Ä–æ–Ω–æ–ª–æ–≥—ñ—è).
- [ ] **–í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è:** –¢–µ—Å—Ç –∑—ñ 100 –æ–¥–Ω–æ—á–∞—Å–Ω–∏–º–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏; –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –≥—Ä–∞—Ñ–∞ (–≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ä–æ–∑—ñ—Ä–≤–∞–Ω–∏—Ö –ª–∞–Ω—Ü—é–∂–∫—ñ–≤).

---

## üß† –ï—Ç–∞–ø 2: –ö–æ–≥–Ω—ñ—Ç–∏–≤–Ω—ñ—Å—Ç—å (The Thinker & Analyst)

**–ú–µ—Ç–∞:** –ù–∞–¥–∞—Ç–∏ –∞–≥–µ–Ω—Ç—É "—Ä–æ–∑—É–º—ñ–Ω–Ω—è" —Ç–∞ "—ñ–Ω—Ç–µ–Ω—Ç".

### 2.1. Stream 2: The Thinker
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `streams/thinker.py`.
- [ ] **Migration:** –ê–¥–∞–ø—Ç—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É `ContextBuilder` –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞—Ä–∞—Ç–∏–≤—ñ–≤.
- [ ] –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –Ω–æ–≤–∏—Ö –≤—É–∑–ª—ñ–≤ `(:Message)`.
- [ ] **–ó–±—ñ—Ä–∫–∞ –ü—Ä–æ–º–ø—Ç–∞ –∑ –ì—Ä–∞—Ñ–∞:** –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ `PromptBuilder`, —â–æ –ø—ñ–¥—Ç—è–≥—É—î –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑ –ì—Ä–∞—Ñ–∞ (–ü—Ä–∞–≤–∏–ª–∞, –ü–µ—Ä—Å–æ–Ω–∞).
- [ ] **–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ù–∞—Ä–∞—Ç–∏–≤—É:** –í–∏–∫–ª–∏–∫ LLM –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è "Narrative Snapshot".
- [ ] –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è `(:Snapshot)`, –ø–æ–≤'—è–∑–∞–Ω–æ–≥–æ –∑ `(:Message)`.
- [ ] –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ **Batch Processing** –¥–ª—è –≤–∏—Å–æ–∫–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

### 2.2. Stream 3: The Analyst
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `streams/analyst.py`.
- [ ] –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ: `Narrative Snapshot`.
- [ ] **–ö–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ü–Ω—Ç–µ–Ω—Ç—É:** –ê–Ω–∞–ª—ñ–∑ –Ω–∞—Ä–∞—Ç–∏–≤—É (–ü–∏—Ç–∞–Ω–Ω—è? –ö–æ–º–∞–Ω–¥–∞? –®—É–º?).
- [ ] **Migration:** –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ª–æ–≥—ñ–∫—É `Gatekeeper` –∑ `core/loop.py` –≤ —Ü–µ–π –ø–æ—Ç—ñ–∫.
- [ ] **–°—Ç—Ä–∞—Ç–µ–≥—ñ—è:** –í–∏–∑–Ω–∞—á–∏—Ç–∏ `Analyst Snapshot` –∑—ñ —Å–ø–∏—Å–∫–æ–º –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –∑–∞–¥–∞—á (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `[Search, Reply]`).
- [ ] –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –≤ –ì—Ä–∞—Ñ.

---

## ‚ö° –ï—Ç–∞–ø 3: –î—ñ—è (The Coordinator & Responder)

**–ú–µ—Ç–∞:** –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ –∑–∞–¥–∞—á—ñ —Ç–∞ —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º.

### 3.1. Stream 4: The Coordinator
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `streams/coordinator.py`.
- [ ] **Asyncio Conductor:** –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–¥–∞—á.
- [ ] **–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –°—Ç–∞–Ω—É:** –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤'—è–∑–∫—É `(:Agent)-[:WORKING_ON]->(:Task)`.
- [ ] **–í–∏–∫–æ–Ω–∞–Ω–Ω—è –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤:** –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è `Researcher` —Ç–∞ —ñ–Ω—à–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤.
- [ ] **Mid-stream Check:** –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∏–≥–Ω–∞–ª—ñ–≤ "–°—Ç–æ–ø" –≤—ñ–¥ Stream 2/3 –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.
- [ ] –í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ: `Context Context` (–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ + –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –ø–ª–∞–Ω).

### 3.2. Stream 5: The Responder
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `streams/responder.py`.
- [ ] **–®–∞—Ä –ü–µ—Ä—Å–æ–Ω–∏:** –ù–∞–∫–ª–∞—Å—Ç–∏ –æ—Å–æ–±–∏—Å—Ç—ñ—Å—Ç—å "Bober Sikfan" –Ω–∞ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç.
- [ ] **Telegram Sender:** –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ `transport/telegram_bot.py` –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.
- [ ] **–ó–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫:** –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ–¥—ñ—ó "Bot Sent Message" –Ω–∞–∑–∞–¥ —É `redis:ingestion_queue` (–≤ Stream 1).

---

## üîó –ï—Ç–∞–ø 4: –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è —Ç–∞ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è

**–ú–µ—Ç–∞:** –ó—Ä–æ–±–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É –Ω–∞–¥—ñ–π–Ω–æ—é —Ç–∞ —à–≤–∏–¥–∫–æ—é.

### 4.1. –°–∏—Å—Ç–µ–º–Ω–∏–π –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `main.py` (–∞–±–æ `ignite.py`) –¥–ª—è –∑–∞–ø—É—Å–∫—É –≤—Å—ñ—Ö 5 –ø–æ—Ç–æ–∫—ñ–≤ —è–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –∑–∞–¥–∞—á –∞–±–æ –æ–∫—Ä–µ–º–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤.
- [ ] –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –Ω–∞–¥—ñ–π–Ω—É –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ñ —Å–ø—Ä–æ–±–∏ (retries) –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫—É.
- [ ] **Final Cleanup:** –í–∏–¥–∞–ª–∏—Ç–∏ `core/loop.py`.

### 4.2. –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ –¥–∞—à–±–æ—Ä–¥ (–∞–±–æ CLI —É—Ç–∏–ª—ñ—Ç—É) –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –ø–æ—Ç–æ–∫—ñ–≤.
- [ ] –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è "–õ–∞–Ω—Ü—é–∂–∫–∞ –î—É–º–æ–∫" —É FalkorDB.

### 4.3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `ARCHITECTURE.md` —Ñ—ñ–Ω–∞–ª—å–Ω–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `OPERATIONS.md` –¥–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º (troubleshooting).
