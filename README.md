# üß† Cursor Workspace with Neon Memory

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Cursor AI —Ç–∞ —Å–∏—Å—Ç–µ–º–æ—é –ø–∞–º'—è—Ç—ñ –Ω–∞ –±–∞–∑—ñ Neon PostgreSQL.**

–¶–µ–π –≤–æ—Ä–∫—Å–ø–µ–π—Å –º—ñ—Å—Ç–∏—Ç—å:
- **Embedding Service** ‚Äî —Å–µ—Ä–≤—ñ—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –≤–µ–∫—Ç–æ—Ä–Ω–∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—å (embeddings) –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º Ollama
- **–°–∏—Å—Ç–µ–º–∞ –ø–∞–º'—è—Ç—ñ** ‚Äî –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–µ—Å—ñ–π —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤ Neon PostgreSQL –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ—à—É–∫—É
- **–ì—Ä–∞—Ñ –∑–Ω–∞–Ω—å** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª, —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤ –¥–ª—è AI –∞–≥–µ–Ω—Ç–∞
- **RAG (Retrieval-Augmented Generation)** ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –¥–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó

---

## üéØ –§—ñ–ª–æ—Å–æ—Ñ—ñ—è –ø—Ä–æ–µ–∫—Ç—É

–¶–µ–π –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª—ñ–∑—É—î —Å–∏—Å—Ç–µ–º—É –ø–∞–º'—è—Ç—ñ –¥–ª—è AI –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≥—Ä–∞—Ñ—É –∑–Ω–∞–Ω—å:

- **–ü—Ä–∞–≤–∏–ª–∞ (Rules)** ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏ —Ä–æ–±–æ—Ç–∏ —Å–∏—Å—Ç–µ–º–∏
- **–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó (Instructions)** ‚Äî –ø–æ–∫—Ä–æ–∫–æ–≤—ñ –∫–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –∑–∞–¥–∞—á
- **–ü—Ä–æ—Ç–æ–∫–æ–ª–∏ (Protocols)** ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω—ñ –Ω–∞–±–æ—Ä–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π –∑ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
- **–ì—Ä–∞—Ñ –∑–Ω–∞–Ω—å** ‚Äî –∑–≤'—è–∑–∫–∏ –º—ñ–∂ –ø—Ä–∞–≤–∏–ª–∞–º–∏, —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏ —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏ —á–µ—Ä–µ–∑ `entity_edges`
- **RAG (Retrieval-Augmented Generation)** ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –¥–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó

–°–∏—Å—Ç–µ–º–∞ –¥–æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –ø—Ä–∏–Ω—Ü–∏–ø—É **Append-Only**: –¥–∞–Ω—ñ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è, —Ç—ñ–ª—å–∫–∏ –∞—Ä—Ö—ñ–≤—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ `valid_to`.

üìñ **–î–µ—Ç–∞–ª—å–Ω–∞ —Ñ—ñ–ª–æ—Å–æ—Ñ—ñ—è:** [`PHILOSOPHY.md`](PHILOSOPHY.md)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
C:\Cursor workspace\
‚îú‚îÄ‚îÄ embedding-service/          # üß¨ –°–µ—Ä–≤—ñ—Å –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó embeddings
‚îÇ   ‚îú‚îÄ‚îÄ app/                    # FastAPI –¥–æ–¥–∞—Ç–æ–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py         # –†–æ–±–æ—Ç–∞ –∑ –ë–î
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ embedding.py        # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è embeddings —á–µ—Ä–µ–∑ Ollama
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.py             # –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
‚îÇ   ‚îú‚îÄ‚îÄ chunking/               # –°—Ç—Ä–∞—Ç–µ–≥—ñ—ó —á–∞–Ω–∫—ñ–Ω–≥—É —Ç–µ–∫—Å—Ç—É
‚îÇ   ‚îú‚îÄ‚îÄ scripts/                # –£—Ç–∏–ª—ñ—Ç–∏ —Ç–∞ —Å–∫—Ä–∏–ø—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate_embeddings_for_all_sessions.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ save_session.py
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml      # Docker –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
‚îÇ   ‚îî‚îÄ‚îÄ README.md               # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è embedding-service
‚îÇ
‚îú‚îÄ‚îÄ migrations/                 # üõ† SQL –º—ñ–≥—Ä–∞—Ü—ñ—ó –¥–ª—è –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ init.sql                # –ü–æ—á–∞—Ç–∫–æ–≤–∞ —Å—Ö–µ–º–∞ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ 003_schema_versioning.sql
‚îÇ   ‚îú‚îÄ‚îÄ 004_add_instructions_and_triggers.sql
‚îÇ   ‚îî‚îÄ‚îÄ 005_cleanup_unused_columns.sql
‚îÇ
‚îú‚îÄ‚îÄ AGENT.md                    # –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è AI –∞–≥–µ–Ω—Ç–∞
‚îú‚îÄ‚îÄ PHILOSOPHY.md               # –§—ñ–ª–æ—Å–æ—Ñ—ñ—è –ø—Ä–æ–µ–∫—Ç—É
‚îî‚îÄ‚îÄ README.md                   # –¶–µ–π —Ñ–∞–π–ª
```

---

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Neon –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

1. –°—Ç–≤–æ—Ä—ñ—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ [Neon](https://console.neon.tech)
2. –í–∏–∫–æ–Ω–∞–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç [`migrations/init.sql`](migrations/init.sql) –≤ –∫–æ–Ω—Å–æ–ª—ñ Neon
3. –ó–±–µ—Ä–µ–∂—ñ—Ç—å connection string

### 2. –ó–∞–ø—É—Å–∫ Embedding Service

#### –í–∞—Ä—ñ–∞–Ω—Ç A: Docker (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

```bash
cd embedding-service

# –°—Ç–≤–æ—Ä—ñ—Ç—å .env —Ñ–∞–π–ª –∑ NEON_CONNECTION_STRING
# –í—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ docker-compose.yml –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å .env

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—ñ–≤
docker-compose up -d

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ Ollama
docker exec embedding-ollama ollama pull embeddinggemma:latest

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
curl http://localhost:8000/api/v1/health
```

#### –í–∞—Ä—ñ–∞–Ω—Ç B: –õ–æ–∫–∞–ª—å–Ω–æ

```bash
cd embedding-service

# –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
pip install -r requirements.txt

# –ó–∞–ø—É—Å—Ç—ñ—Ç—å Ollama –ª–æ–∫–∞–ª—å–Ω–æ
ollama pull embeddinggemma:latest

# –ù–∞–ª–∞—à—Ç—É–π—Ç–µ .env –∑ NEON_CONNECTION_STRING

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—É
python -m app.main
```

### 3. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Cursor + Neon MCP

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Cursor Settings ‚Üí Tools & MCP
2. –î–æ–¥–∞–π—Ç–µ Neon MCP —Å–µ—Ä–≤–µ—Ä –∑ connection string
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ —Å–µ—Ä–≤–µ—Ä –∞–∫—Ç–∏–≤–Ω–∏–π

---

## üß¨ Embedding Service

–°–µ—Ä–≤—ñ—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó embeddings –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –ª–æ–∫–∞–ª—å–Ω–æ—ó –º–æ–¥–µ–ª—ñ Ollama EmbeddingGemma.

### –û—Å–Ω–æ–≤–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:

- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è embeddings —á–µ—Ä–µ–∑ REST API
- ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ä—ñ–∑–Ω–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥—ñ–π —á–∞–Ω–∫—ñ–Ω–≥—É (simple, recursive, semantic)
- ‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è embeddings –≤ Neon PostgreSQL –∑ pgvector
- ‚úÖ Batch –æ–±—Ä–æ–±–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- ‚úÖ API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó embeddings –¥–ª—è –≤—Å—ñ—Ö —Å–µ—Å—ñ–π
- ‚úÖ **RAG (Retrieval-Augmented Generation)** ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –ø–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º —Ç–∞ —Å—É—Ç–Ω–æ—Å—Ç—è–º
- ‚úÖ **–ì—Ä–∞—Ñ –∑–Ω–∞–Ω—å** ‚Äî —Ä–æ–±–æ—Ç–∞ –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏, —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏ —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏
- ‚úÖ **–í–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —Å—Ö–µ–º–∏** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π

### API Endpoints:

#### –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è embeddings
- `POST /api/v1/embed` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è embedding –¥–ª—è —Ç–µ–∫—Å—Ç—É
- `POST /api/v1/embed-chunked` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è embeddings –¥–ª—è —á–∞–Ω–∫–æ–≤–∞–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É
- `GET /api/v1/strategies` ‚Äî —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥—ñ–π —á–∞–Ω–∫—ñ–Ω–≥—É

#### –†–æ–±–æ—Ç–∞ –∑ —Å–µ—Å—ñ—è–º–∏
- `POST /api/v1/sessions` ‚Äî –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–µ—Å—ñ—ó –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏
- `POST /api/v1/sessions/{session_id}/generate-embeddings` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è embeddings –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Å–µ—Å—ñ—ó
- `POST /api/v1/sessions/generate-embeddings/all` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è embeddings –¥–ª—è –≤—Å—ñ—Ö —Å–µ—Å—ñ–π
- `GET /api/v1/sessions/stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ —Å–µ—Å—ñ—ó —Ç–∞ embeddings

#### RAG (Retrieval-Augmented Generation)
- `POST /api/v1/rag/search-messages` ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –ø–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
- `POST /api/v1/rag/search-entities` ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –ø–æ —Å—É—Ç–Ω–æ—Å—Ç—è–º –≥—Ä–∞—Ñ—É –∑–Ω–∞–Ω—å

#### –†–æ–±–æ—Ç–∞ –∑ –≥—Ä–∞—Ñ–æ–º –∑–Ω–∞–Ω—å
- `GET /api/v1/rules/critical` ‚Äî –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª
- `GET /api/v1/entities/{entity_id}/children` ‚Äî –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—á—ñ—Ä–Ω—ñ—Ö —Å—É—Ç–Ω–æ—Å—Ç–µ–π
- `POST /api/v1/messages/{message_id}/link-entity` ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤'—è–∑–∫—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è-—Å—É—Ç–Ω—ñ—Å—Ç—å
- `POST /api/v1/sessions/{session_id}/link-entity` ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤'—è–∑–∫—É —Å–µ—Å—ñ—è-—Å—É—Ç–Ω—ñ—Å—Ç—å

#### –°–∏—Å—Ç–µ–º–Ω—ñ
- `GET /api/v1/health` ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤'—è —Å–µ—Ä–≤—ñ—Å—É

üìñ **–î–µ—Ç–∞–ª—å–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:** [`embedding-service/README.md`](embedding-service/README.md)

---

## üîç RAG (Retrieval-Augmented Generation)

–°–∏—Å—Ç–µ–º–∞ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –¥–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏—Ö —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —Ç–∞ —ñ—Å—Ç–æ—Ä—ñ—ó —Å–µ—Å—ñ–π:

### –í–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –ø–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
```bash
POST /api/v1/rag/search-messages
Content-Type: application/json

{
  "query_text": "–Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö?",
  "limit": 10,
  "similarity_threshold": 0.7,
  "session_id": "optional-session-id",
  "role": "assistant"
}
```

### –í–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –ø–æ —Å—É—Ç–Ω–æ—Å—Ç—è–º –≥—Ä–∞—Ñ—É –∑–Ω–∞–Ω—å
```bash
POST /api/v1/rag/search-entities
Content-Type: application/json

{
  "query_text": "–Ø–∫ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Å–µ—Å—ñ—ó?",
  "types": ["Instruction", "Protocol"],
  "limit": 10,
  "similarity_threshold": 0.7,
  "active_only": true
}
```

## üìö –†–æ–±–æ—Ç–∞ –∑ –≥—Ä–∞—Ñ–æ–º –∑–Ω–∞–Ω—å

### –ö—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —Å–∏—Å—Ç–µ–º–∏

–°–∏—Å—Ç–µ–º–∞ –º—ñ—Å—Ç–∏—Ç—å 9 –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª, —è–∫—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:

1. **AlwaysConfirmBeforeChanges** - –ó–ê–í–ñ–î–ò –æ—Ç—Ä–∏–º—É–π —è–≤–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –≤–Ω–µ—Å–µ–Ω–Ω—è–º –∑–º—ñ–Ω
2. **AppendOnlyPrinciple** - –ù—ñ–∫–æ–ª–∏ –Ω–µ –≤–∏–¥–∞–ª—è–π –¥–∞–Ω—ñ, —Ç—ñ–ª—å–∫–∏ –∞—Ä—Ö—ñ–≤—É–π
3. **EntityRelationships** - –ó–∞–≤–∂–¥–∏ —Å—Ç–≤–æ—Ä—é–π –∑–≤'—è–∑–∫–∏ —á–µ—Ä–µ–∑ entity_edges
4. **ProjectBranching** - –ù–æ–≤—ñ –ø—Ä–æ–µ–∫—Ç–∏ = –Ω–æ–≤—ñ –≥—ñ–ª–∫–∏ –≤ Neon
5. **SessionContextSave** - –ó–±–µ—Ä—ñ–≥–∞–π –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ embeddings —Ç–∞ –∑–≤'—è–∑–∫–∞–º–∏
6. **SourcePriority** - –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –¥–∂–µ—Ä–µ–ª —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
7. **TemporalFacts** - –¢–µ–º–ø–æ—Ä–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è –≤—Å—ñ—Ö —Ñ–∞–∫—Ç—ñ–≤
8. **UseExistingTools** - –ü–µ—Ä–µ–≤—ñ—Ä—è–π –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —ñ—Å–Ω—É—é—á–∏—Ö —Ä—ñ—à–µ–Ω—å
9. **VerifyBeforeAct** - –ü–µ—Ä–µ–≤—ñ—Ä—è–π —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–¥ –∑–≥–∞–¥—É–≤–∞–Ω–Ω—è–º

–î–µ—Ç–∞–ª—å–Ω—ñ –æ–ø–∏—Å–∏ –ø—Ä–∞–≤–∏–ª –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ API: `GET /api/v1/rules/critical`

### –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª
```bash
GET /api/v1/rules/critical
```

### –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—á—ñ—Ä–Ω—ñ—Ö —Å—É—Ç–Ω–æ—Å—Ç–µ–π
```bash
GET /api/v1/entities/{entity_id}/children?relation_type=contains&child_type=Instruction
```

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤'—è–∑–∫—ñ–≤ –º—ñ–∂ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏ —Ç–∞ –ø—Ä–∞–≤–∏–ª–∞–º–∏
```bash
POST /api/v1/messages/{message_id}/link-entity?entity_id={rule_id}&relation_type=uses
```

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤'—è–∑–∫—ñ–≤ –º—ñ–∂ —Å–µ—Å—ñ—è–º–∏ —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏
```bash
POST /api/v1/sessions/{session_id}/link-entity?entity_id={protocol_id}&relation_type=executed_in
```

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –º—ñ—Å—Ç–∏—Ç—å:

- **sessions** ‚Äî –º–µ—Ç–∞–¥–∞–Ω—ñ —Å–µ—Å—ñ–π (id, topic, created_at, metadata)
- **messages** ‚Äî –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ embeddings (session_id, role, content, embedding_v2, embedding_model_id)
- **entity_nodes** ‚Äî –≤—É–∑–ª–∏ –≥—Ä–∞—Ñ—É –∑–Ω–∞–Ω—å (–ø—Ä–∞–≤–∏–ª–∞, —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó, –ø—Ä–æ—Ç–æ–∫–æ–ª–∏, —Ñ–∞–∫—Ç–∏)
  - type: 'Rule' | 'Instruction' | 'Protocol' | 'Fact' | 'Technology' | 'Tool' | 'SystemNode'
- **entity_edges** ‚Äî –∑–≤'—è–∑–∫–∏ –º—ñ–∂ –≤—É–∑–ª–∞–º–∏
  - relation_type: 'contains' | 'uses' | 'depends_on' | 'applies_to' | 'applies' | 'executed_in'
- **protocol_triggers** ‚Äî —Ç—Ä–∏–≥–µ—Ä–∏ –¥–ª—è –∑–∞–ø—É—Å–∫—É –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤
- **message_entity_links** ‚Äî –∑–≤'—è–∑–∫–∏ –º—ñ–∂ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏ —Ç–∞ –ø—Ä–∞–≤–∏–ª–∞–º–∏/—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏
- **session_entity_links** ‚Äî –∑–≤'—è–∑–∫–∏ –º—ñ–∂ —Å–µ—Å—ñ—è–º–∏ —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏
- **embedding_models** ‚Äî –º–µ—Ç–∞–¥–∞–Ω—ñ –º–æ–¥–µ–ª–µ–π embeddings
- **schema_migrations** ‚Äî —ñ—Å—Ç–æ—Ä—ñ—è –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∏—Ö –º—ñ–≥—Ä–∞—Ü—ñ–π

–í—Å—ñ embeddings –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –∫–æ–ª–æ–Ω—Ü—ñ `embedding_v2` —Ç–∏–ø—É `vector(768)`.

## üîÑ –í–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —Å—Ö–µ–º–∏

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂—É—î –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—é `schema_migrations`:

```sql
-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó
SELECT version, name, description, applied_at 
FROM schema_migrations 
ORDER BY version;
```

–ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –≤—Ä—É—á–Ω—É —á–µ—Ä–µ–∑ Neon Console –∞–±–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç–∏.

---

## üìù –°–∫—Ä–∏–ø—Ç–∏ —Ç–∞ —É—Ç–∏–ª—ñ—Ç–∏

### –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π** `scripts/run_migrations.py`:

```bash
# Dry run (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —â–æ –±—É–¥–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ)
python scripts/run_migrations.py --dry-run

# –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π
NEON_CONNECTION_STRING="..." python scripts/run_migrations.py

# –ê–±–æ –∑ —è–≤–Ω–∏–º connection string
python scripts/run_migrations.py --connection-string "postgresql://..."
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
- –ó–Ω–∞—Ö–æ–¥–∏—Ç—å –≤—Å—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó –≤ `migrations/` –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î —è–∫—ñ –≤–∂–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ —á–µ—Ä–µ–∑ `schema_migrations`
- –ó–∞—Å—Ç–æ—Å–æ–≤—É—î —Ç—ñ–ª—å–∫–∏ –Ω–æ–≤—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î checksums –¥–ª—è –±–µ–∑–ø–µ–∫–∏

### –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≥—Ä–∞—Ñ—É –∑–Ω–∞–Ω—å

**Seed —Å–∫—Ä–∏–ø—Ç** –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–∞–∑–æ–≤–∏—Ö –ø—Ä–∞–≤–∏–ª, —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤:

```bash
# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
NEON_CONNECTION_STRING="..." python scripts/seed_knowledge_graph.py

# –ê–±–æ –∑ —è–≤–Ω–∏–º connection string
python scripts/seed_knowledge_graph.py --connection-string "postgresql://..."
```

–°–∫—Ä–∏–ø—Ç —Å—Ç–≤–æ—Ä—é—î:
- CriticalRules system node
- 9 –±–∞–∑–æ–≤–∏—Ö –ø—Ä–∞–≤–∏–ª (–≤–∫–ª—é—á–∞—é—á–∏ AlwaysConfirmBeforeChanges)
- 5 –±–∞–∑–æ–≤–∏—Ö —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π (–≤–∫–ª—é—á–∞—é—á–∏ ChangeConfirmationInstruction)
- 2 –ø—Ä–æ—Ç–æ–∫–æ–ª–∏ (Bootstrap Protocol —Ç–∞ SafeChangeProtocol)
- –í—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –∑–≤'—è–∑–∫–∏ –º—ñ–∂ —Å—É—Ç–Ω–æ—Å—Ç—è–º–∏

### –†–æ–±–æ—Ç–∞ –∑ –≥—Ä–∞—Ñ–æ–º –∑–Ω–∞–Ω—å (CLI)

**CLI —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç** –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª–∞–º–∏, —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏ —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏:

```bash
# –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ
python scripts/knowledge_graph_cli.py create-rule \
  --name "MyRule" \
  --description "–û–ø–∏—Å –ø—Ä–∞–≤–∏–ª–∞" \
  --link-to-critical

# –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é
python scripts/knowledge_graph_cli.py create-instruction \
  --name "MyInstruction" \
  --description "–û–ø–∏—Å —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó" \
  --rule-ids "rule-id-1" "rule-id-2"

# –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª
python scripts/knowledge_graph_cli.py create-protocol \
  --name "MyProtocol" \
  --description "–û–ø–∏—Å –ø—Ä–æ—Ç–æ–∫–æ–ª—É" \
  --instruction-ids "inst-id-1" "inst-id-2" \
  --triggers "—Ç—Ä–∏–≥–µ—Ä 1" "—Ç—Ä–∏–≥–µ—Ä 2"

# –°–ø–∏—Å–æ–∫ —Å—É—Ç–Ω–æ—Å—Ç–µ–π
python scripts/knowledge_graph_cli.py list --type Rule
python scripts/knowledge_graph_cli.py list --type Instruction

# –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ —Å—É—Ç–Ω–æ—Å—Ç—ñ
python scripts/knowledge_graph_cli.py show --id "entity-id"

# –ü–æ—à—É–∫ —Å—É—Ç–Ω–æ—Å—Ç–µ–π
python scripts/knowledge_graph_cli.py search --query "–ø–æ—à—É–∫"

# –ó–≤'—è–∑–∞—Ç–∏ –¥–≤—ñ —Å—É—Ç–Ω–æ—Å—Ç—ñ
python scripts/knowledge_graph_cli.py link \
  --source-id "source-id" \
  --target-id "target-id" \
  --relation-type "uses"
```

### –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è embeddings –¥–ª—è –≤—Å—ñ—Ö —Å–µ—Å—ñ–π

```bash
# –ß–µ—Ä–µ–∑ Docker
docker exec -e NEON_CONNECTION_STRING="..." embedding-service \
  python /app/scripts/generate_embeddings_for_all_sessions.py

# –õ–æ–∫–∞–ª—å–Ω–æ
cd embedding-service
python scripts/generate_embeddings_for_all_sessions.py
```

### –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–µ—Å—ñ—ó

**–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Å–∫—Ä–∏–ø—Ç `save_session.py`** –ø—Ä–∏–π–º–∞—î –¥–∞–Ω—ñ –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª:

```bash
# 1. –ó stdin (JSON)
echo '{"topic": "Test", "messages": [{"role": "user", "content": "Hello"}]}' | \
  python scripts/save_session.py

# 2. –ó —Ñ–∞–π–ª—É
python scripts/save_session.py --file session.json

# 3. –ß–µ—Ä–µ–∑ API (—è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π)
python scripts/save_session.py --use-api --file session.json

# 4. –ó –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞
python scripts/save_session.py \
  --topic "Test Session" \
  --messages '[{"role": "user", "content": "Hello"}]'

# –ß–µ—Ä–µ–∑ Docker
docker exec -e NEON_CONNECTION_STRING="..." embedding-service \
  python /app/scripts/save_session.py --file /app/session.json
```

**–§–æ—Ä–º–∞—Ç JSON —Ñ–∞–π–ª—É:**
```json
{
  "topic": "–ù–∞–∑–≤–∞ —Å–µ—Å—ñ—ó (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)",
  "messages": [
    {"role": "user", "content": "–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"},
    {"role": "assistant", "content": "–í—ñ–¥–ø–æ–≤—ñ–¥—å"}
  ],
  "generate_embeddings": true,
  "metadata": {"source": "custom", "custom_field": "value"}
}
```

---

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

- **Neon PostgreSQL** + **pgvector** ‚Äî –±–∞–∑–∞ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–∞–º'—è—Ç—ñ —Ç–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ—à—É–∫—É
- **Ollama** + **EmbeddingGemma** ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è embeddings
- **FastAPI** ‚Äî REST API —Å–µ—Ä–≤—ñ—Å
- **Docker** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü—ñ—è
- **MCP (Model Context Protocol)** ‚Äî —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Cursor AI

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ —Å–µ—Å—ñ—ó —Ç–∞ embeddings:

```bash
# –ß–µ—Ä–µ–∑ API
curl http://localhost:8000/api/v1/sessions/stats

# –ê–±–æ —á–µ—Ä–µ–∑ Neon MCP
# –ü–æ–ø—Ä–æ—Å—ñ—Ç—å AI: "–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ —Å–µ—Å—ñ—ó –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö"
```

---

## üîß –†–æ–∑—Ä–æ–±–∫–∞

### –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö endpoints

1. –î–æ–¥–∞–π—Ç–µ endpoint –≤ `embedding-service/app/api/routes.py`
2. –î–æ–¥–∞–π—Ç–µ –º–µ—Ç–æ–¥–∏ –≤ `embedding-service/app/database.py` —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤—ñ—Å

### –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```bash
# Health check
curl http://localhost:8000/api/v1/health

# –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è embedding
curl -X POST http://localhost:8000/api/v1/embed \
  -H "Content-Type: application/json" \
  -d '{"text": "Test text"}'

# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è API
# –í—ñ–¥–∫—Ä–∏–π—Ç–µ http://localhost:8000/docs
```

---

## üìÑ –õ—ñ—Ü–µ–Ω–∑—ñ—è

MIT License
