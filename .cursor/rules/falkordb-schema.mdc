---
description: FalkorDB Knowledge Graph Schema з темпоральністю
globs: **/*.py, **/*.md
---

# FalkorDB Schema

Ти працюєш з базою даних FalkorDB (Graph Database).
Використовуй `python scripts/db_cli.py` для взаємодії.

## Вузли (Nodes)

### Session
- `id`: string (UUID)
- `topic`: string
- `file_path`: string
- `date`: string
- `created_at`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_from`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_to`: timestamp | null (null = активний)

### Message
- `id`: string (UUID)
- `role`: 'user' | 'assistant'
- `content`: string (повний текст)
- `created_at`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_from`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_to`: timestamp | null (null = активний)

### Entity
- `id`: string (UUID)
- `name`: string (унікальна назва)
- `type`: string (тип сутності)
- `embedding`: JSON string (вектор ТІЛЬКИ для сутностей, зберігається як JSON)
- `created_at`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_from`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_to`: timestamp | null (null = активний)

## Зв'язки (Relationships)

### [:HAS_MESSAGE]
Зв'язує Session з Message.
- `created_at`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_from`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_to`: timestamp | null (null = активний)

### [:NEXT]
Зв'язує Message в хронологічному порядку (Linked List).
- `created_at`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_from`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_to`: timestamp | null (null = активний)

### [:MENTIONS]
Зв'язує Message з Entity (з вагою).
- `weight`: float (починається з 1.0)
- `created_at`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_from`: timestamp (ISO формат рядка, передається як параметр $timestamp)
- `valid_to`: timestamp | null (null = активний)

## Принцип Append-Only

При зміні даних:
1. Закрити старий запис: `SET valid_to = $timestamp` (де $timestamp - поточний ISO timestamp)
2. Створити новий запис: `valid_from = $timestamp, valid_to = null`

**Важливо:** FalkorDB не підтримує функцію `datetime()` в Cypher. Timestamp передається як параметр у форматі ISO (наприклад, `2026-01-27T17:30:00.123456`).

Ніколи не видаляти дані, тільки архівувати.

## Фільтрація активних записів

Завжди фільтруй активні записи:
```cypher
MATCH (n:Entity)
WHERE n.valid_to IS NULL
RETURN n
```

## Cypher Examples

1. Знайти останні повідомлення:
   ```cypher
   MATCH (s:Session)-[:HAS_MESSAGE]->(m:Message)
   WHERE s.valid_to IS NULL AND m.valid_to IS NULL
   RETURN m.content LIMIT 5
   ```

2. Знайти сутності, згадані в повідомленнях:
   ```cypher
   MATCH (m:Message)-[r:MENTIONS]->(e:Entity)
   WHERE m.valid_to IS NULL AND r.valid_to IS NULL AND e.valid_to IS NULL
   RETURN e.name, e.type, r.weight
   LIMIT 10
   ```

3. Знайти сесію з темою:
   ```cypher
   MATCH (s:Session)
   WHERE s.topic CONTAINS 'міграція' AND s.valid_to IS NULL
   RETURN s.topic, s.file_path
   ```
