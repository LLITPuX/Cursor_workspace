---
description: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏ FastAPI —Ä–æ–∑—Ä–æ–±–∫–∏. –ê–∫—Ç–∏–≤—É—î—Ç—å—Å—è –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ FastAPI –ø—Ä–æ–µ–∫—Ç–∞–º–∏.
globs: ["**/main.py", "**/routers/**/*.py", "**/api/**/*.py"]
alwaysApply: false
---

# ‚ö° FastAPI ‚Äî –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏ —Ä–æ–∑—Ä–æ–±–∫–∏

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
project/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # FastAPI app initialization
‚îÇ   ‚îú‚îÄ‚îÄ config.py            # Settings (Pydantic BaseSettings)
‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py      # Shared dependencies
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ routers/             # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ items.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Pydantic models (schemas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ item.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_service.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ repositories/        # Database operations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_repo.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ db/                  # Database configuration
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ database.py
‚îÇ       ‚îî‚îÄ‚îÄ models.py        # SQLAlchemy models
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ alembic/                 # Migrations
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ docker-compose.yml
```

## üéØ –ë–∞–∑–æ–≤–∏–π —à–∞–±–ª–æ–Ω main.py

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from src.config import settings
from src.routers import users, items
from src.db.database import init_db, close_db


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Application lifespan: startup and shutdown."""
    await init_db()
    yield
    await close_db()


app = FastAPI(
    title=settings.PROJECT_NAME,
    version=settings.VERSION,
    lifespan=lifespan,
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Routers
app.include_router(users.router, prefix="/api/v1/users", tags=["users"])
app.include_router(items.router, prefix="/api/v1/items", tags=["items"])


@app.get("/health")
async def health_check():
    """Health check endpoint."""
    return {"status": "healthy"}
```

## üì¶ Pydantic Models (Schemas)

```python
from datetime import datetime
from typing import Optional
from pydantic import BaseModel, EmailStr, Field


# Base model (shared fields)
class UserBase(BaseModel):
    email: EmailStr
    name: str = Field(..., min_length=2, max_length=100)


# Create request
class UserCreate(UserBase):
    password: str = Field(..., min_length=8)


# Update request
class UserUpdate(BaseModel):
    email: Optional[EmailStr] = None
    name: Optional[str] = Field(None, min_length=2, max_length=100)


# Response model
class UserResponse(UserBase):
    id: int
    created_at: datetime
    
    model_config = {"from_attributes": True}


# List response with pagination
class UserListResponse(BaseModel):
    items: list[UserResponse]
    total: int
    page: int
    per_page: int
```

## üõ£Ô∏è Router (Endpoint)

```python
from fastapi import APIRouter, Depends, HTTPException, status, Query
from typing import Annotated

from src.models.user import UserCreate, UserResponse, UserListResponse
from src.services.user_service import UserService
from src.dependencies import get_user_service, get_current_user

router = APIRouter()


@router.get("/", response_model=UserListResponse)
async def get_users(
    service: Annotated[UserService, Depends(get_user_service)],
    page: int = Query(1, ge=1),
    per_page: int = Query(10, ge=1, le=100),
):
    """Get paginated list of users."""
    return await service.get_users(page=page, per_page=per_page)


@router.get("/{user_id}", response_model=UserResponse)
async def get_user(
    user_id: int,
    service: Annotated[UserService, Depends(get_user_service)],
):
    """Get user by ID."""
    user = await service.get_user(user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"User {user_id} not found",
        )
    return user


@router.post("/", response_model=UserResponse, status_code=status.HTTP_201_CREATED)
async def create_user(
    data: UserCreate,
    service: Annotated[UserService, Depends(get_user_service)],
):
    """Create new user."""
    return await service.create_user(data)
```

## ‚öôÔ∏è Config (Settings)

```python
from pydantic_settings import BaseSettings
from functools import lru_cache


class Settings(BaseSettings):
    PROJECT_NAME: str = "My API"
    VERSION: str = "1.0.0"
    DEBUG: bool = False
    
    # Database
    DATABASE_URL: str
    
    # Security
    SECRET_KEY: str
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    
    # CORS
    ALLOWED_ORIGINS: list[str] = ["http://localhost:3000"]
    
    model_config = {
        "env_file": ".env",
        "env_file_encoding": "utf-8",
    }


@lru_cache
def get_settings() -> Settings:
    return Settings()


settings = get_settings()
```

## üîê Dependencies

```python
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from typing import Annotated

from src.services.user_service import UserService
from src.db.database import get_db

security = HTTPBearer()


async def get_user_service(db=Depends(get_db)) -> UserService:
    """Dependency: UserService instance."""
    return UserService(db)


async def get_current_user(
    credentials: Annotated[HTTPAuthorizationCredentials, Depends(security)],
    service: Annotated[UserService, Depends(get_user_service)],
):
    """Dependency: Current authenticated user."""
    token = credentials.credentials
    user = await service.verify_token(token)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials",
        )
    return user
```

## üö´ –ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ

- ‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤ async endpoints
- ‚ùå –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ –ø—Ä—è–º–æ –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö
- ‚ùå –ó–∞—Ö–∞—Ä–¥–∫–æ–¥–∂–µ–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π Settings)
- ‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö
