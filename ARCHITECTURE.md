# –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ Gemini Observer

**–í–µ—Ä—Å—ñ—è:** 1.0
**–¢–∏–ø:** Event-Driven Async Microservices
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω–∞ (Production-Ready Basics)

---

## üß† –ó–∞–≥–∞–ª—å–Ω–∏–π –û–≥–ª—è–¥

Gemini Observer ‚Äî —Ü–µ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞, –ø–æ–±—É–¥–æ–≤–∞–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø—ñ **Event Loop**, –¥–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–ø—ñ–ª–∫—É—é—Ç—å—Å—è –≤–∏–∫–ª—é—á–Ω–æ —á–µ—Ä–µ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –¶–µ –∑–∞–±–µ–∑–ø–µ—á—É—î –≤–∏—Å–æ–∫—É —Å—Ç—ñ–π–∫—ñ—Å—Ç—å: –ø–∞–¥—ñ–Ω–Ω—è –æ–¥–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Sender) –Ω–µ –±–ª–æ–∫—É—î —Ä–æ–±–æ—Ç—É —ñ–Ω—à–∏—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Listener –ø—Ä–æ–¥–æ–≤–∂—É—î –∑–±–∏—Ä–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è).

–°—Ç—Ä–∏–∂–µ–Ω—å —Å–∏—Å—Ç–µ–º–∏ ‚Äî **Redis**, —è–∫–∏–π –≤–∏—Å—Ç—É–ø–∞—î —è–∫ Message Broker.

---

## üîÑ –°—Ö–µ–º–∞ –ü–æ—Ç–æ–∫—É –î–∞–Ω–∏—Ö (Data Flow)

```mermaid
sequenceDiagram
    participant User
    participant Telegram API
    participant Listener
    participant Redis Queue
    participant Brain (Loop)
    participant Gemini/Ollama
    participant Sender

    User->>Telegram API: Send Message
    Listener->>Telegram API: Get Updates (Long Polling)
    Listener->>Redis Queue: Push Update (RPUSH telegram_updates)
    
    loop RalphLoop (Brain)
        Brain->>Redis Queue: BLPOP telegram_updates
        Brain->>Brain: Analyze Intent
        alt Primary Provider
            Brain->>Gemini: Generate Response
        else Circuit Breaker (Backup)
            Brain->>Ollama: Generate Response (Local Cortex)
        end
        Brain->>Redis Queue: Push Response (RPUSH agent_responses)
    end

    loop Sender Loop
        Sender->>Redis Queue: BLPOP agent_responses
        Sender->>Telegram API: Send Message
    end
    
    Telegram API->>User: Message Delivered
```

---

## üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –°–∏—Å—Ç–µ–º–∏

### 1. Listener Service (`gemini-observer/core/listener.py` - *conceptual*)
*–§–∞–∫—Ç–∏—á–Ω–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —è–∫ –æ–∫—Ä–µ–º–∏–π Task –≤ `main.py`*
*   **–§—É–Ω–∫—Ü—ñ—è:** –í–∏–∫–æ–Ω—É—î Long Polling –¥–æ Telegram API.
*   **–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å:**
    *   –û—Ç—Ä–∏–º–∞–Ω–Ω—è updates.
    *   –î–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ).
    *   –°–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ JSON.
    *   –ó–∞–ø–∏—Å —É —á–µ—Ä–≥—É `telegram_updates`.

### 2. Brain Service (`gemini-observer/core/loop.py`)
*   **–§—É–Ω–∫—Ü—ñ—è:** "–ú–æ–∑–æ–∫" –∞–≥–µ–Ω—Ç–∞. –û–±—Ä–æ–±–ª—è—î –≤—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ —Ç–∞ –≥–µ–Ω–µ—Ä—É—î –≤–∏—Ö—ñ–¥–Ω—ñ.
*   **–ö–ª–∞—Å:** `RalphLoop`.
*   **–õ–æ–≥—ñ–∫–∞:**
    1.  **Input:** –ë–ª–æ–∫—É—é—á–µ —á–∏—Ç–∞–Ω–Ω—è (`blpop`) –∑ Redis.
    2.  **LLM Routing:** –í–∏–±—ñ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —á–µ—Ä–µ–∑ `LLMProvider` (Gemini vs Ollama).
    3.  **System Prompt:** –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è LLM –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∑ `core/prompts.py` —ñ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.
    4.  **Circuit Breaker:** –Ø–∫—â–æ Gemini –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ–º–∏–ª–∫—É (429, 500, Timeout), –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–º–∏–∫–∞—î—Ç—å—Å—è –Ω–∞ `backup_provider` (Ollama).
    5.  **Output:** –ó–∞–ø–∏—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —É —á–µ—Ä–≥—É `agent_responses`.

### 3. Sender Service (`gemini-observer/transport/sender.py`)
*   **–§—É–Ω–∫—Ü—ñ—è:** "–†—É–∫–∏" –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.
*   **–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:**
    *   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `CustomSession` –¥–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º –∑ Docker/Windows IPv4.
    *   –£–ø—Ä–∞–≤–ª—è—î Rate Limits Telegram API.

### 4. Memory (FalkorDB)
*   **–§—É–Ω–∫—Ü—ñ—è:** –î–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–∞ –ø–∞–º'—è—Ç—å.
*   **–ó–≤'—è–∑–æ–∫:** Brain –∑–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ Memory Provider –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è/—á–∏—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—î—é –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
*   **–°—Ç–∞—Ç—É—Å:** –ë–∞–∑–æ–≤–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≥—Ä–∞—Ñ–∞.
*   **Graph Segregation:**
    *   `agent_memory`: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –≥—Ä–∞—Ñ –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó Agent <-> Bot Owner (—Å–∏—Å—Ç–µ–º–∞).
    *   `group_chat_memory`: –Ü–∑–æ–ª—å–æ–≤–∞–Ω–∏–π –≥—Ä–∞—Ñ –¥–ª—è –≥—Ä—É–ø–æ–≤–∏—Ö —á–∞—Ç—ñ–≤.
    *   –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ `settings.FALKORDB_GRAPH_*`.

---

## üõ°Ô∏è Local Cortex (–ú–µ—Ö–∞–Ω—ñ–∑–º –°—Ç—ñ–π–∫–æ—Å—Ç—ñ)

**Local Cortex** ‚Äî —Ü–µ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–∏–π –ø–∞—Ç–µ—Ä–Ω –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –±–µ–∑–ø–µ—Ä–µ—Ä–≤–Ω–æ—Å—Ç—ñ —Ä–æ–±–æ—Ç–∏.

*   **Primary:** Google Gemini (Cloud). –ü–æ—Ç—É–∂–Ω–∞, –∞–ª–µ –º–∞—î –∫–≤–æ—Ç–∏ —Ç–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –º–µ—Ä–µ–∂—ñ.
*   **Backup:** Gemma 2 2B (Local via Ollama). –ú–µ–Ω—à –ø–æ—Ç—É–∂–Ω–∞, –∞–ª–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∞ —ñ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞.
*   **–õ–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è:**
    *   Brain –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏–∫–æ–Ω–∞—Ç–∏ –∑–∞–ø–∏—Ç –¥–æ Main Provider.
    *   `try/except` –ª–æ–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏.
    *   –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ —Å–ø—ñ–π–º–∞–Ω–∞ -> –≤–∏–∫–ª–∏–∫ Backup Provider.
    *   –î–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –¥–æ–¥–∞—î—Ç—å—Å—è –º–µ—Ç–∞-—Ç–µ–≥ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—ñ–¥–ø–∏—Å "Generated by Local Cortex"), —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–≤ –ø—Ä–æ –∑–Ω–∏–∂–µ–Ω–Ω—è —è–∫–æ—Å—Ç—ñ.

### Model Selection (Benchmark Driven)
–í–∏–±—ñ—Ä –ª–æ–∫–∞–ª—å–Ω–æ—ó –º–æ–¥–µ–ª—ñ (`Gemma 2`, `Mistral`, `Qwen 2.5`) –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–∏—Ö –±–µ–Ω—á–º–∞—Ä–∫—ñ–≤ (`scripts/benchmark_models.py`), —è–∫—ñ –æ—Ü—ñ–Ω—é—é—Ç—å:
- **Speed:** Token/sec —Ç–∞ Time To First Token (TTFT).
- **Logic:** –ó–¥–∞—Ç–Ω—ñ—Å—Ç—å –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –≤–∞–ª—ñ–¥–Ω–∏–π JSON.
- **Resource Usage:** –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑ –¥–æ—Å—Ç—É–ø–Ω–∏–º –∑–∞–ª—ñ–∑–æ–º.

---

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∞–Ω–∏—Ö (Redis)

### –ß–µ—Ä–≥–∏ (Lists)
*   `telegram_updates`: JSON-–æ–±'—î–∫—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω—å –≤—ñ–¥ Telegram.
*   `agent_responses`: JSON-–æ–±'—î–∫—Ç–∏ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (`{"chat_id": ..., "text": ...}`).

### –ö–ª—é—á—ñ (Keys)
*   `bot_state`: (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞.

---

## üöÄ –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è

–ó–∞–≤–¥—è–∫–∏ Redis, –∫–æ–∂–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –≤ –æ–∫—Ä–µ–º–∏–π Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–ø—É—Å—Ç–∏—Ç–∏ 5 Brain-–≤–æ—Ä–∫–µ—Ä—ñ–≤ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ —á–µ—Ä–≥–∏), —è–∫—â–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑—Ä–æ—Å—Ç–µ.
